# 实时投票系统技术文档

## 一、系统架构简述

本系统采用前后端分离架构，通过WebSocket实现实时数据推送，整体架构如下：

```
┌─────────────────┐    HTTP/API       ┌─────────────────┐
│   Vue3 前端     │ <──────────────>   │  FastAPI 后端   │
│  (Port 5173)    │   REST API        │  (Port 8000)    │
│                 │                   │                 │
│   用户浏览器     │ <── WebSocket ──> │ WebSocket 管理  │
└─────────────────┘                   └─────────────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │   SQLite 数据库  │
                                    └─────────────────┘
```

**架构特点：**
- 前端负责界面渲染、用户交互、展示实时投票结果
- 后端提供投票API、数据库管理和WebSocket实时推送功能
- SQLite作为轻量级数据库存储投票数据

## 二、API 接口说明

### 2.1 获取投票信息

**接口描述：** 获取当前投票问题和各选项的票数

- **URL：** `/api/poll`
- **方法：** `GET`
- **请求参数：** 无
- **响应格式：** JSON

**响应示例：**
```json
{
  "question": "你最喜欢的编程语言是？",
  "options": [
    {
      "id": 1,
      "text": "Python",
      "votes": 10
    },
    {
      "id": 2,
      "text": "Java",
      "votes": 7
    },
    {
      "id": 3,
      "text": "C",
      "votes": 5
    }
  ]
}
```

### 2.2 投票接口

**接口描述：** 提交用户投票

- **URL：** `/api/poll/vote`
- **方法：** `POST`
- **Content-Type：** `application/json`

**请求参数：**
```json
{
  "option_id": 1
}
```

**参数说明：**
- `option_id` (int): 选项ID，必填

**响应示例：**
```json
{
  "message": "投票成功",
  "status": "success"
}
```

**错误响应：**
```json
{
  "message": "无效的选项ID",
  "status": "error"
}
```

## 三、实时推送机制说明

### 3.1 WebSocket连接

- **端点：** `/ws/poll`
- **协议：** WebSocket
- **用途：** 实时推送投票结果更新

### 3.2 推送流程

1. **连接建立：** 客户端通过JavaScript建立WebSocket连接
2. **初始数据：** 服务器立即发送当前投票状态给新连接的客户端
3. **实时更新：** 当有新投票提交时，服务器广播最新数据给所有连接的客户端
4. **断线重连：** 客户端检测到连接断开时自动尝试重连

### 3.3 消息格式

**服务器推送消息格式：**
```json
{
  "type": "poll_update",
  "data": {
    "question": "你最喜欢的编程语言是？",
    "options": [
      {
        "id": 1,
        "text": "Python",
        "votes": 11
      }
    ],
    "total_votes": 23
  }
}
```

### 3.4 客户端实现示例

```javascript
// 建立WebSocket连接
const ws = new WebSocket('ws://localhost:8000/ws/poll');

// 接收消息
ws.onmessage = function(event) {
  const data = JSON.parse(event.data);
  if (data.type === 'poll_update') {
    updatePollDisplay(data.data);
  }
};

// 连接断开时重连
ws.onclose = function() {
  setTimeout(() => {
    connectWebSocket();
  }, 3000);
};
```

## 四、技术选型说明

### 4.1 后端技术栈

| 技术 | 版本 | 选型理由 |
|------|------|----------|
| **FastAPI** | 0.100+ | 现代Python Web框架，原生支持异步编程和WebSocket，API文档自动生成，性能优秀 |
| **SQLite** | 3.x | 轻量级数据库，零配置，文件存储，适合小型应用快速部署 |
| **Uvicorn** | 0.20+ | ASGI服务器，支持异步请求处理，与FastAPI完美配合 |

### 4.2 前端技术栈

| 技术 | 版本 | 选型理由 |
|------|------|----------|
| **Vue3** | 3.x | 渐进式框架，组合式API，响应式数据绑定，易于构建实时更新界面 |
| **Vite** | 4.x | 快速构建工具，热重载，开发体验优秀 |
| **TypeScript** | 4.x | 类型安全，提高代码质量和开发效率 |

### 4.3 部署技术

| 技术 | 说明 |
|------|------|
| **Docker** | 容器化部署，环境一致性，跨平台运行 |
| **Docker Compose** | 多容器编排，简化开发和部署流程 |

### 4.4 通信协议

| 协议 | 用途 | 优势 |
|------|------|------|
| **HTTP/REST** | API调用 | 标准化，易于理解和调试 |
| **WebSocket** | 实时推送 | 双向通信，低延迟，适合实时应用 |

## 五、系统特性

### 5.1 核心功能
- 实时投票统计
- 多客户端同步更新
- 简洁的用户界面
- RESTful API设计

### 5.2 性能特点
- 异步处理，高并发支持
- 轻量级数据库，快速响应
- WebSocket推送，实时性强

### 5.3 扩展性
- 模块化设计，易于功能扩展
- 支持多种数据库切换
- 前后端分离，便于独立开发

## 六、部署说明

### 6.1 Docker部署

```bash
# 构建并启动所有服务
docker-compose up --build

# 后台运行
docker-compose up -d
```

## 七、总结

本实时投票系统采用现代化技术栈，具有以下优势：

- **技术先进：** 使用FastAPI + Vue3，支持异步编程和现代前端开发
- **实时性强：** WebSocket实现毫秒级数据推送
- **部署简单：** Docker容器化，一键部署
- **易于扩展：** 模块化设计，便于功能迭代

系统适合作为实时投票、问卷调查、实时统计等场景的基础框架，后续可根据业务需求进行定制化开发。